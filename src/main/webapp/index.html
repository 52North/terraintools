<html>
    <head>
        <title>52n-terraintools</title>
        <script type="text/javascript">
            var auth2 = auth2 || {};

            (function () {
                var po = document.createElement('script');
                po.type = 'text/javascript';
                po.async = true;
                po.src = 'https://plus.google.com/js/client:plusone.js?onload=startApp';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(po, s);
            })();
        </script>
        <!-- JavaScript specific to this application that is not related to API
           calls -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" ></script>
    </head>
    <style>
        #customBtn {
            width: 155px;
        }
        #customBtn:hover {
            box-shadow: 2px 2px 3px #888888;
            border-radius: 5px;
            cursor: hand;
        }
    </style>
    <body>
        <div id="gConnect">
            <h1>Welcome to terraintools!</h1>
            <img id="customBtn" src="https://developers.google.com/+/images/branding/sign-in-buttons/btn_google+_signin_dark_normal_web.png" onClick="signInClick()"
                 alt="Sign in with Google+" />
            <p>If you've already signed in, click refresh!
                <img id="loading" style="display:none" src="https://ssl.gstatic.com/s2/oz/images/notifications/spinner_32_041dcfce66a2d43215abb96b38313ba0.gif"/>
            </p>
        </div>
        <div id="authOps" style="display:none">
            <div id="profile"></div>
            <div id="visiblePeople"></div>
            <h2>Authentication Logs</h2>
            <pre id="authResult"></pre>
        </div>
    </body>
    <script type="text/javascript">
        var developerKey = 'AIzaSyB2yc3lA0UTXlpB7EL9HVddU4YPo17ZwhU';
        var pickerApiLoaded = false;
        var oauthToken;
        var picker = null;

        var helper = (function () {
            var authResult = undefined;

            return {
                /**
                 * Hides the sign-in button and connects the server-side app after
                 * the user successfully signs in.
                 *
                 * @param {Object} authResult An Object which contains the access token and
                 *   other authentication information.
                 */
                onSignInCallback: function (authResult) {
                    oauthToken = authResult.access_token;
                    $('#authResult').html('Auth Result:<br/>');
                    for (var field in authResult) {
                        $('#authResult').append(' ' + field + ': ' + authResult[field] + '<br/>');
                    }
                    if (authResult['access_token']) {
                        // The user is signed in
                        this.authResult = authResult;

                        gapi.load('picker', {'callback': onPickerApiLoad});

                        // After we load the Google+ API, render the profile data from Google+.
                        gapi.client.load('plus', 'v1', this.renderProfile);

                        // After we load the profile, retrieve the list of people visible to
                        // this app, server-side.
                        helper.people();
                    } else if (authResult['error']) {
                        // There was an error, which means the user is not signed in.
                        // As an example, you can troubleshoot by writing to the console:
                        console.log('There was an error: ' + authResult['error']);
                        $('#authResult').append('Logged out');
                        $('#authOps').hide('slow');
                        $('#gConnect').show();
                    }
                    console.log('authResult', authResult);
                },
                /**
                 * Retrieves and renders the authenticated user's Google+ profile.
                 */
                renderProfile: function () {
                    var request = gapi.client.plus.people.get({'userId': 'me'});
                    request.execute(function (profile) {
                        $('#profile').empty();
                        if (profile.error) {
                            $('#profile').append(profile.error);
                            return;
                        }
                        $('#profile').append(
                                $('<p>Hello ' + profile.displayName + '!</p>'));
                    });
                    $('#authOps').show('slow');
                    $('#gConnect').hide();
                },
                /**
                 * Calls the server endpoint to connect the app for the user. The client
                 * sends the one-time authorization code to the server and the server
                 * exchanges the code for its own tokens to use for offline API access.
                 * For more information, see:
                 *   https://developers.google.com/+/web/signin/server-side-flow
                 */
                connectServer: function (code) {
                    $('#loading').show('slow');
                    console.log(code);
                    $.ajax({
                        type: 'POST',
                        url: $(location).attr('origin') + '/connect',
                        contentType: 'application/octet-stream; charset=utf-8',
                        success: function (result) {
                            console.log(result);
                            helper.people();
                            onSignInCallback(auth2.currentUser.get().getAuthResponse());
                        },
                        processData: false,
                        data: code
                    });
                },
                /**
                 * Calls the server endpoint to get the list of people visible to this app.
                 * @param success Callback called on success.
                 * @param failure Callback called on error.
                 */
                people: function (success, failure) {
                    success = success || function (result) {
                        helper.appendCircled(result);
                    };
                    $.ajax({
                        type: 'GET',
                        url: $(location).attr('origin') + '/people',
                        contentType: 'application/octet-stream; charset=utf-8',
                        success: success,
                        error: failure,
                        processData: false
                    });
                },
                /**
                 * Displays visible People retrieved from server.
                 *
                 * @param {Object} people A list of Google+ Person resources.
                 */
                appendCircled: function (people) {
                    $('#visiblePeople').empty();
                    $('#visiblePeople').append(people);
                },
            };
        })();

        /**
         * Called after the Google client library has loaded.
         */
        function startApp() {
            gapi.load('auth2', function () {

                // Retrieve the singleton for the GoogleAuth library and setup the client.
                gapi.auth2.init({
                    client_id: '948086675144-fq6u0ajvdi4mp8bt2ovh4p87mmrpesg7.apps.googleusercontent.com',
                    cookiepolicy: 'single_host_origin',
                    fetch_basic_profile: false,
                    scope: "https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/drive",
                    immediate: true
                }).then(function () {
                    console.log('init');
                    auth2 = gapi.auth2.getAuthInstance();
                    auth2.then(function () {
                        var isAuthedCallback = function () {
                            onSignInCallback(auth2.currentUser.get().getAuthResponse())
                        }
                        helper.people(isAuthedCallback);
                    });
                });
            });
        }

        function onPickerApiLoad() {
            pickerApiLoaded = true;
            createPicker();
        }

        // Create and render a Picker object for picking user Documents.
        function createPicker() {
            if (pickerApiLoaded && oauthToken) {
                var folderView = new google.picker.View(google.picker.ViewId.FOLDERS);
                folderView.setQuery("52n-terraintools");
                picker = new google.picker.PickerBuilder().
                        addView(folderView).
                        setOAuthToken(oauthToken).
                        setDeveloperKey(developerKey).
                        setCallback(pickerCallback).
                        build();
                picker.setVisible(false);
            }
        }

        // A simple callback implementation.
        function pickerCallback(data) {
            var url = 'nothing';
            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                var doc = data[google.picker.Response.DOCUMENTS][0];
                console.log(doc);
                url = doc[google.picker.Document.URL];
            }
            var message = 'You picked: ' + url;
            document.getElementById('picked').innerHTML = message;
        }

        // Make the picker visible
        function showPicker() {
            console.log(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token);
            picker.setVisible(true);
        }

        /**
         * Either signs the user in or authorizes the back-end.
         */
        function signInClick() {
            var signIn = function (result) {
                auth2.signIn().then(
                        function (googleUser) {
                            onSignInCallback(googleUser.getAuthResponse());
                        }, function (error) {
                    alert(JSON.stringify(error, undefined, 2));
                });
            };

            var reauthorize = function () {
                auth2.grantOfflineAccess().then(
                        function (result) {
                            helper.connectServer(result.code);
                        });
            };

            helper.people(signIn, reauthorize);
        }

        /**
         * Calls the helper method that handles the authentication flow.
         *
         * @param {Object} authResult An Object which contains the access token and
         *   other authentication information.
         */
        function onSignInCallback(authResult) {
            helper.onSignInCallback(authResult);
        }
    </script>
</html>
